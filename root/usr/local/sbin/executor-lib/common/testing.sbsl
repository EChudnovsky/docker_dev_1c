#требуется СтруктурыДанных.sbsl
#требуется testing/Утверждения.sbsl
#требуется testing/Тесты.sbsl

// ПРОГРАММЫЙ ИНТЕРФЕЙС ТЕСТОВЫХ МЕТОДОВ

@Глобально
структура T
    знч ПараметрыОкружения: СтруктурыДанных.ПараметрыОкружения
    пер assert: Утверждения.assert

    @Глобально
    статический метод T(t: Строка|testing.T?): T
        выбор t
        когда это Строка
            знч Тест  = новый T()
            возврат Тест
        когда это testing.T
            возврат t как testing.T
        иначе
            знч Тест  = новый T()
            возврат Тест
        ;
    ;

;

// МЕСТОДЫ ДЛЯ РАБОТЫ С ТЕСТАМИ

@Глобально
метод НайтиФайлыТестовыхСкриптов(ПутьПоиска: Строка): ЧитаемыйМассив<Файл>
    ПутьПоиска = ПутьПоиска.Сократить()
    ПутьПоиска = ПутьПоиска.Пусто() ?  "${Файлы.СимволРазделителя}." : ПутьПоиска
    
    знч Файл = новый Файл(ПутьПоиска)
    выбор
    когда не Файл.Существует()
        выбросить новый ИсключениеНедопустимоеСостояние("Не удалось найти тестовые файлы")
    когда Файл.ЭтоФайл()
        возврат [Файл]
    иначе
        знч НастройкиПоиска = новый НастройкиПоискаФайлов()
        НастройкиПоиска
            .ИмяСодержит("_test.sbsl")
            .МаксимальнаяГлубина(Неопределено)            

        возврат Файлы.Найти(ПутьПоиска, НастройкиПоиска)
    ;
;

@Глобально
метод ПрочитатьСписокТестов(ФайлСкриптаТеста: Строка|Файл, СписокТестов: Тесты.ОписаниеТестов? = Неопределено): Тесты.ОписаниеТестов
    
    если СписокТестов == Неопределено
        СписокТестов = новый Тесты.ОписаниеТестов()
    ;
    
    если ФайлСкриптаТеста это Строка
        ФайлСкриптаТеста = новый Файл(ФайлСкриптаТеста как Строка)
        если не (ФайлСкриптаТеста как Файл).Существует()
            выбросить  новый ИсключениеНедопустимыйАргумент(
                "При получении списка тестов не удалось найти файл: ${(ФайлСкриптаТеста как Файл).Путь}")
        ;
    ;

    исп ПотокЧтения = (ФайлСкриптаТеста как Файл).ОткрытьПотокЧтения()
    знч ТекстСкрипта = ПотокЧтения.ПрочитатьКакСтроку()
    
    // Находим все сочетания в строке
    знч РезультатПоиска: Массив<Совпадение>
    РезультатПоиска.ДобавитьВсе('^@Глобально\н^\s*метод\s*(?<М>test\w*)(?ims)'.НайтиСовпадения(ТекстСкрипта))
    РезультатПоиска.ДобавитьВсе('^@Глобально\н^\s*метод\s*(?<М>test\w*)(?ims)'.НайтиСовпадения(ТекстСкрипта))

    // пер НоваяСтрока = ""
    для Совпадение из РезультатПоиска
        пер ИмяМетода = Совпадение.Группа("М")
        СписокТестов.ДобавитьТест((ФайлСкриптаТеста как Файл).Путь, ИмяМетода, ИмяМетода)
    ;
    
    возврат СписокТестов
;

метод Скрипт(ПутьПоискаТестов: Строка = "", ИмяТестаИлиФайла: Строка = "")
    
    знч СписокТестов = новый Тесты.ОписаниеТестов()
    пер МассиСкриптов = НайтиФайлыТестовыхСкриптов(ПутьПоискаТестов)
    для ФайлСкриптаТеста из МассиСкриптов
        ПрочитатьСписокТестов(ФайлСкриптаТеста, СписокТестов)
    ;
    
    СписокТестов.Запустить(ИмяТестаИлиФайла)

;